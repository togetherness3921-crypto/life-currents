<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Connection Test</title>
    <style>
        body { font-family: sans-serif; padding: 1em; }
        #output { white-space: pre-wrap; background-color: #f4f4f4; border: 1px solid #ccc; padding: 1em; }
    </style>
</head>
<body>
    <h1>MCP Connection Test</h1>
    <p>Open the browser's developer console (F12) to see detailed logs.</p>
    <div id="output"></div>

    <script type="module">
        import { McpClient } from '/src/lib/mcp/client.ts';

        const outputDiv = document.getElementById('output');
        const log = (message, ...args) => {
            console.log(message, ...args);
            const line = document.createElement('div');
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message} ${args.length > 0 ? JSON.stringify(args, null, 2) : ''}`;
            outputDiv.appendChild(line);
        };
        const logError = (message, ...args) => {
            console.error(message, ...args);
            const line = document.createElement('div');
            line.style.color = 'red';
            line.textContent = `[${new Date().toLocaleTimeString()}] ERROR: ${message} ${args.length > 0 ? JSON.stringify(args, null, 2) : ''}`;
            outputDiv.appendChild(line);
        };


        const MCP_SERVER_BASE = 'https://remote-mcp-server-authless.harveymushman394.workers.dev';

        const testMcpConnection = async () => {
            log(`Connecting to server at ${MCP_SERVER_BASE}...`);
            const client = new McpClient(MCP_SERVER_BASE);

            try {
                await client.connect();
                log('Connection successful.');

                log('Fetching available tools...');
                const tools = await client.listTools();
                
                if (tools.length === 0) {
                    log('Warning: No tools found on the server.');
                } else {
                    log('Available tools:', tools);
                }

                const toolNameToTest = 'get_graph_structure';
                log(`Calling tool: "${toolNameToTest}" with no arguments...`);

                const toolExists = tools.some((tool) => tool.name === toolNameToTest);
                if (!toolExists && tools.length > 0) {
                    logError(`Tool "${toolNameToTest}" not found.`);
                    return;
                }
                
                const result = await client.callTool(toolNameToTest, {});

                log('Tool call successful. Result:', result);

            } catch (error) {
                logError('An error occurred during the test:', error.message, error.stack);
            } finally {
                log('Closing connection.');
                client.close();
            }
        };

        testMcpConnection();
    </script>
</body>
</html>
